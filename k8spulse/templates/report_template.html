<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ env_name }} Statistics Report</title>
    <link rel="icon" href="https://res.cloudinary.com/dyknhuvxt/image/upload/c_thumb,w_200,g_face/v1730740391/k8spulse_axrf38.png">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #334e68;
            padding: 20px;
        }
        h2 {
            color: #0f766e;
            font-weight: bold;
        }
        .card {
            background: #ffffff;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow-wrap: break-word;
        }
        .gauge-row, .chart-container {
            display: flex;
            gap: 20px;
            justify-content: space-around;
            margin-top: 20px;
        }
        .gauge-container, .semaphore-container {
            text-align: center;
        }
        .semaphore-container, .gauge-container {
            flex: 1;
        }
        .semaphore-container {
            text-align: left;
            padding-left: 20px;
            max-width: 150px;
        }
        .semaphore-container .status-box {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            max-width: 130px;
        }
        .semaphore-container .status-box:hover {
            overflow: visible;
            white-space: normal;
        }
        .chart {
            text-align: center;
            display: inline-block;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #0f766e;
            color: white;
            font-weight: bold;
        }
        .events, .nodes {
            width: 48%;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .event {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
        }
        .event-warning {
            background-color: #ffe69a;
            color: #92400e;
        }
        .event-error {
            background-color: #fecaca;
            color: #b91c1c;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-ok {
            background-color: #16a34a;
        }
        .status-error {
            background-color: #dc2626;
        }
        .status-warning {
            background-color: #f97316;
        }
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 100px;
        }
        .gauge img {
            width: 80%;
            height: auto;
        }
        .gauge-title {
            font-size: 10px;
        }
        .events-nodes-row {
            display: flex;
            gap: 4%;
            justify-content: space-between;
        }
        details pre {
            background-color: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            overflow: auto;
            max-height: 200px;
            font-family: 'Courier New', monospace;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .logo img {
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <div class="logo">
        <img src="https://res.cloudinary.com/dyknhuvxt/image/upload/v1730740391/k8spulse_axrf38.png" alt="k8spulse logo">
        <h2>{{ env_name }} Statistics Report - {{ timestamp }}</h2>
    </div>

    <!-- Semaphores and Gauges in the Same Row -->
    <div class="gauge-row">
        <!-- Semaphores -->
        <div class="semaphore-container">
            <h3>Service Status Indicators</h3>
            <div class="status-box">
                <div class="status-indicator {{ 'status-ok' if metrics_server_status else 'status-error' }}"></div>
                Metrics Server
            </div>
            <div class="status-box">
                <div class="status-indicator {{ 'status-ok' if kube_dns_status else 'status-error' }}"></div>
                Kube-DNS
            </div>
            <div class="status-box">
                <div class="status-indicator {{ 'status-ok' if cast_ai_agent_status else 'status-error' }}"></div>
                CAST AI Agent
            </div>
            <div class="status-box">
                <div class="status-indicator {{ 'status-ok' if cast_ai_workload_autoscaler_status else 'status-error' }}"></div>
                CAST AI Workload Autoscaler
            </div>
            <div class="status-box">
                <div class="status-indicator {{ 'status-ok' if cast_ai_cluster_controller_status else 'status-error' }}"></div>
                CAST AI Cluster Controller
            </div>
        </div>

        <!-- Gauges -->
        <div class="gauge-container">
            <img src="data:image/png;base64,{{ gauge_chart_deployments_with_replicas }}" alt="Deployments with Replicas">
            <div>({{ (deployments_with_replicas / total_deployments * 100) | round(2) }}%) ({{ deployments_with_replicas }})</div>
        </div>
        <div class="gauge-container">
            <img src="data:image/png;base64,{{ gauge_chart_deployments_zero_replicas }}" alt="Deployments with Zero Replicas">
            <div>({{ (deployments_with_zero_replicas / total_deployments * 100) | round(2) }}%) ({{ deployments_with_zero_replicas }})</div>
        </div>
        <div class="gauge-container">
            <img src="data:image/png;base64,{{ gauge_chart_exact_replicas }}" alt="Deployments with Exact Replicas">
            <div>({{ (deployments_with_exact_replicas / total_deployments * 100) | round(2) }}%) ({{ deployments_with_exact_replicas }})</div>
        </div>
        <div class="gauge-container">
            <img src="data:image/png;base64,{{ gauge_chart_crashloopbackoff }}" alt="Pods in CrashLoopBackOff">
            <div>({{ (pods_with_crashloopbackoff / total_deployments * 100) | round(2) }}%) ({{ pods_with_crashloopbackoff }})</div>
        </div>
        <div class="gauge-container">
            <img src="data:image/png;base64,{{ gauge_chart_recently_restarted }}" alt="Recently Restarted Pods">
            <div>({{ (deployments_with_recent_start / total_deployments * 100) | round(2) }}%) ({{ deployments_with_recent_start }})</div>
        </div>
    </div>

    <!-- Optional OpenAI Recommendation -->
    {% if use_ai and openai_recommendation %}
        <div class="card" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
            <h3>OpenAI Recommendation</h3>
            <div style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">{{ openai_recommendation }}</div>
        </div>
    {% endif %}

    <!-- Events and Nodes in the Same Row -->
    <div class="events-nodes-row">
        <!-- Unusual Events -->
        <div class="events">
            <h3>Unusual Events</h3>
            {% if unusual_events %}
                {% for event in unusual_events %}
                    <div class="event {{ 'event-warning' if event.reason == 'Warning' else 'event-error' }}">
                        <strong>Namespace:</strong> {{ event.namespace }}<br>
                        <strong>Reason:</strong> {{ event.reason }}<br>
                        <strong>Message:</strong> {{ event.message }}<br>
                        <strong>Count:</strong> {{ event.count }}<br>
                        <strong>First Occurrence:</strong> {{ event.first_timestamp }}<br>
                        <strong>Last Occurrence:</strong> {{ event.last_timestamp }}
                    </div>
                {% endfor %}
            {% else %}
                <div class="event">No unusual events found.</div>
            {% endif %}
        </div>

        <!-- Nodes with Issues -->
        <div class="nodes">
            <h3>Nodes with Issues</h3>
            {% if nodes_with_issues %}
                {% for node in nodes_with_issues %}
                    <div class="event event-error">
                        <strong>Node:</strong> {{ node.name }}<br>
                        <strong>Status:</strong> {{ node.status }}<br>
                        <details>
                            <summary>Details</summary>
                            <pre><code>{{ node.description }}</code></pre>
                        </details>
                    </div>
                {% endfor %}
            {% else %}
                <div class="event">All nodes are healthy.</div>
            {% endif %}
        </div>
    </div>

    <!-- Line Charts -->
    <div class="chart-container">
        <div class="chart">
            <img src="data:image/png;base64,{{ line_chart_image }}" alt="Deployment and Pod Statistics">
        </div>
    </div>

    <!-- Last 24-Hour History Table -->
    <h3>Last 24-Hour History</h3>
    <table>
        <tr>
            <th>Time</th>
            <th>Total Deployments</th>
            <th>With Replica</th>
            <th>No Replica</th>
            <th>Exactly Desired</th>
            <th>CrashLoopBackOff</th>
            <th>Recently Restarted</th>
            <th>Nodes with Issues</th>
        </tr>
        {% for row in history_data %}
            <tr>
                <td>{{ row.timestamp }}</td>
                <td>{{ row.total_deployments }}</td>
                <td>{{ row.deployments_with_replicas }} ({{ (row.deployments_with_replicas / row.total_deployments * 100) | round(2) }}%)</td>
                <td>{{ row.deployments_with_zero_replicas }} ({{ (row.deployments_with_zero_replicas / row.total_deployments * 100) | round(2) }}%)</td>
                <td>{{ row.deployments_with_exact_replicas }} ({{ (row.deployments_with_exact_replicas / row.total_deployments * 100) | round(2) }}%)</td>
                <td>{{ row.pods_with_crashloopbackoff }} ({{ (row.pods_with_crashloopbackoff / row.total_deployments * 100) | round(2) }}%)</td>
                <td>{{ row.deployments_with_recent_start }} ({{ (row.deployments_with_recent_start / row.total_deployments * 100) | round(2) }}%)</td>
                <td>{{ row.nodes_with_issues }}</td>
            </tr>
        {% endfor %}
    </table>
</body>
</html>
